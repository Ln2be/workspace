<!DOCTYPE html>
<html>
  <head>
    <title>Multi-Segment Generator</title>
    <style>
      #svg {
        border: 1px solid #000;
      }
      button {
        margin: 10px;
        padding: 5px 15px;
      }
    </style>
  </head>
  <body>
    <button id="toggleMode">Switch to Line Mode</button>
    <button id="clearAll">Clear All</button>
    <svg id="svg" width="800" height="600"></svg>

    <script>
      let segments = []; // Stores all drawn segments
      let currentMode = "arc"; // 'arc' or 'line'
      let tempPoints = []; // Temporary points for current segment

      // Main click handler
      function handleClick(event) {
        const svg = document.getElementById("svg");
        const rect = svg.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;

        if (currentMode === "arc") {
          handleArcClick(x, y);
        } else {
          handleLineClick(x, y);
        }
      }

      function handleArcClick(x, y) {
        tempPoints.push({ x, y });
        drawPoint(x, y, "arc-point");

        if (tempPoints.length === 3) {
          const [A, B, C] = tempPoints;
          const circle = calculateCircle(A, B, C);

          if (!circle) {
            alert("Points are collinear!");
            tempPoints = [];
            redrawCanvas();
            return;
          }

          segments.push({
            type: "arc",
            points: [...tempPoints],
            circle: { ...circle },
          });
          tempPoints = [];
          redrawCanvas();
        }
      }

      function handleLineClick(x, y) {
        tempPoints.push({ x, y });
        drawPoint(x, y, "line-point");

        if (tempPoints.length === 2) {
          segments.push({
            type: "line",
            points: [...tempPoints],
          });
          tempPoints = [];
          redrawCanvas();
        }
      }

      // Redraw entire canvas
      function redrawCanvas() {
        clearCanvas();

        // Draw stored segments
        segments.forEach((segment) => {
          if (segment.type === "arc") {
            drawArcSegment(segment);
          } else {
            drawLineSegment(segment);
          }
        });

        // Draw temporary points
        tempPoints.forEach((point) => {
          drawPoint(point.x, point.y, `${currentMode}-point`);
        });
      }

      function drawArcSegment(segment) {
        // Draw reference circle
        const circle = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "circle"
        );
        circle.setAttribute("cx", segment.circle.cx);
        circle.setAttribute("cy", segment.circle.cy);
        circle.setAttribute("r", segment.circle.radius);
        circle.setAttribute("stroke", "#cccccc");
        circle.setAttribute("fill", "none");
        document.getElementById("svg").appendChild(circle);

        // Draw arc
        const sorted = [...segment.points].sort((a, b) => a.x - b.x);
        const [left, middle, right] = sorted;
        const path = createArcPath(segment.circle, left, middle, right);
        document.getElementById("svg").appendChild(path);

        // Draw points
        segment.points.forEach((p) => drawPoint(p.x, p.y, "arc-point"));
      }

      function drawLineSegment(segment) {
        const line = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "line"
        );
        line.setAttribute("x1", segment.points[0].x);
        line.setAttribute("y1", segment.points[0].y);
        line.setAttribute("x2", segment.points[1].x);
        line.setAttribute("y2", segment.points[1].y);
        line.setAttribute("stroke", "green");
        line.setAttribute("stroke-width", "2");
        document.getElementById("svg").appendChild(line);

        // Draw points
        segment.points.forEach((p) => drawPoint(p.x, p.y, "line-point"));
      }

      function createArcPath(circle, left, middle, right) {
        const thetaL = calculateAngle(left, circle.cx, circle.cy);
        const thetaM = calculateAngle(middle, circle.cx, circle.cy);
        const thetaR = calculateAngle(right, circle.cx, circle.cy);

        const sweepFlag = isMiddleInClockwise(thetaL, thetaR, thetaM) ? 1 : 0;
        const angle = sweepFlag
          ? (thetaR - thetaL + 2 * Math.PI) % (2 * Math.PI)
          : (thetaL - thetaR + 2 * Math.PI) % (2 * Math.PI);
        const largeArcFlag = angle > Math.PI ? 1 : 0;

        const path = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "path"
        );
        path.setAttribute(
          "d",
          `M ${left.x},${left.y} A ${circle.radius} ${circle.radius} 0 ${largeArcFlag} ${sweepFlag} ${right.x},${right.y}`
        );
        path.setAttribute("stroke", "blue");
        path.setAttribute("fill", "none");
        path.setAttribute("stroke-width", "2");
        return path;
      }

      // Original utility functions
      function calculateCircle(A, B, C) {
        const D =
          2 * (A.x * (B.y - C.y) + B.x * (C.y - A.y) + C.x * (A.y - B.y));
        if (D === 0) return null;

        const cx =
          ((A.x ** 2 + A.y ** 2) * (B.y - C.y) +
            (B.x ** 2 + B.y ** 2) * (C.y - A.y) +
            (C.x ** 2 + C.y ** 2) * (A.y - B.y)) /
          D;
        const cy =
          ((A.x ** 2 + A.y ** 2) * (C.x - B.x) +
            (B.x ** 2 + B.y ** 2) * (A.x - C.x) +
            (C.x ** 2 + C.y ** 2) * (B.x - A.x)) /
          D;
        return { cx, cy, radius: Math.hypot(A.x - cx, A.y - cy) };
      }

      function calculateAngle(point, cx, cy) {
        const dx = point.x - cx;
        const dy = point.y - cy;
        const angle = Math.atan2(dy, dx);
        return angle < 0 ? angle + 2 * Math.PI : angle;
      }

      function isMiddleInClockwise(thetaL, thetaR, thetaM) {
        return (
          (thetaM - thetaL + 2 * Math.PI) % (2 * Math.PI) <=
          (thetaR - thetaL + 2 * Math.PI) % (2 * Math.PI)
        );
      }

      function drawPoint(x, y, className) {
        const point = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "circle"
        );
        point.setAttribute("cx", x);
        point.setAttribute("cy", y);
        point.setAttribute("r", "3");
        point.setAttribute("fill", className === "arc-point" ? "red" : "green");
        point.classList.add(className);
        document.getElementById("svg").appendChild(point);
      }

      function clearCanvas() {
        const svg = document.getElementById("svg");
        while (svg.firstChild) {
          svg.removeChild(svg.firstChild);
        }
      }

      // Event listeners
      document.getElementById("svg").addEventListener("click", handleClick);
      document.getElementById("toggleMode").addEventListener("click", () => {
        currentMode = currentMode === "arc" ? "line" : "arc";
        document.getElementById("toggleMode").textContent = `Switch to ${
          currentMode === "arc" ? "Line" : "Arc"
        } Mode`;
        tempPoints = [];
        redrawCanvas();
      });
      document.getElementById("clearAll").addEventListener("click", () => {
        segments = [];
        tempPoints = [];
        redrawCanvas();
      });
    </script>
  </body>
</html>
